<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ARSLAN REPARTO ‚Äî Repartidor</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- LZString (para leer ?data= comprimido) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

  <style>
    :root{
      --bg:#ffffff; --ink:#0f172a; --muted:#64748b;
      --panel:#f8fafc; --border:#e2e8f0;
      --kiwi:#16a34a; --kiwi2:#15803d;
      --bad:#dc2626; --warn:#f59e0b;
      --shadow:0 2px 10px rgba(0,0,0,.06);
    }
    [data-theme="dark"]{
      --bg:#0b0f14; --ink:#e5e7eb; --muted:#9aa0a6;
      --panel:#111827; --border:#1f2937;
      --shadow:0 2px 14px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      margin:0; background:var(--bg); color:var(--ink);
    }
    .topbar{
      position:sticky; top:0; z-index:50;
      background:var(--bg); border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; backdrop-filter:saturate(1.2) blur(6px);
    }
    .title{ display:flex; flex-direction:column; gap:2px; line-height:1.1; }
    .title b{font-size:15px}
    .title span{font-size:12px; color:var(--muted)}
    .btn{
      border:1px solid var(--border); background:var(--panel);
      color:var(--ink); padding:8px 10px; border-radius:12px;
      cursor:pointer; font-size:13px;
      white-space:nowrap;
    }
    .btn.primary{
      border:1px solid var(--kiwi);
      background:linear-gradient(135deg,var(--kiwi) 0%, var(--kiwi2) 100%);
      color:#fff;
    }
    .btn.danger{
      border:1px solid #fecaca; background:#fee2e2; color:#991b1b;
    }
    [data-theme="dark"] .btn.danger{ background:#2b0d0d; border-color:#7f1d1d; color:#fecaca; }

    .container{ padding:12px 12px 90px; max-width:980px; margin:0 auto; }
    .card{
      border:1px solid var(--border); background:var(--bg);
      border-radius:16px; box-shadow:var(--shadow); overflow:hidden;
      margin-bottom:12px;
    }
    .card .hd{
      display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;
      padding:10px 12px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(22,163,74,.08), rgba(0,0,0,0));
    }
    .card .hd strong{font-size:14px}
    .card .bd{ padding:10px 12px; }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; color:var(--muted);
      background:var(--panel); border:1px solid var(--border);
      padding:4px 8px; border-radius:999px;
      white-space:nowrap;
    }
    .pill.ok{ border-color:#bbf7d0; background:#ecfdf5; color:#166534; }
    .pill.bad{ border-color:#fecaca; background:#fee2e2; color:#991b1b; }
    [data-theme="dark"] .pill.ok{ background:#052e1a; border-color:#14532d; color:#86efac; }
    [data-theme="dark"] .pill.bad{ background:#2b0d0d; border-color:#7f1d1d; color:#fecaca; }

    .dest-grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:900px){ .dest-grid{ grid-template-columns:1fr 1fr; } }

    table{ width:100%; border-collapse:collapse; }
    th,td{ border-bottom:1px solid var(--border); padding:10px 8px; vertical-align:top; }
    th{ font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; }
    td{ font-size:14px; }
    .muted{ color:var(--muted); font-size:12px; }
    .row-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

    .check{ width:18px; height:18px; accent-color: var(--kiwi); transform: translateY(2px); }

    .photo-wrap{
      display:flex; flex-direction:column; gap:10px;
      border-top:1px dashed var(--border);
      margin-top:10px; padding-top:10px;
    }
    .photos{ display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; }
    @media(min-width:700px){ .photos{ grid-template-columns:repeat(4, 1fr); } }
    .ph{
      border:1px solid var(--border); border-radius:12px;
      background:var(--panel); overflow:hidden; position:relative;
      min-height:82px; display:flex; align-items:center; justify-content:center;
    }
    .ph img{ width:100%; height:100%; object-fit:cover; display:block; }
    .ph .rm{
      position:absolute; top:6px; right:6px;
      border:none; background:rgba(0,0,0,.55); color:#fff;
      width:28px; height:28px; border-radius:10px; cursor:pointer;
      font-size:14px;
    }

    .summary{ display:none; }
    .summary.show{ display:block; }
    .summary h2{ margin:0 0 6px; font-size:16px; }
    .summary .sub{ margin:0 0 10px; color:var(--muted); font-size:12px; }
    .grid2{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:900px){ .grid2{ grid-template-columns:1fr 1fr; } }

    @media print{
      .topbar, .no-print{ display:none !important; }
      body{ background:#fff; color:#000; }
      .card{ box-shadow:none; }
      .container{ padding:0; max-width:none; }
      .summary{ display:block !important; }
      .card .hd{ background:none; }
      a[href]:after{ content:""; }
    }
  </style>
</head>

<body>
  <div class="topbar no-print">
    <div class="title">
      <b>üöö ARSLAN REPARTO ‚Äî Repartidor</b>
      <span id="metaLine">Cargando‚Ä¶</span>
    </div>

    <div class="row-actions">
      <button class="btn" onclick="toggleTheme()">üåó Tema</button>
      <button class="btn" onclick="expandAll(true)">‚¨áÔ∏è Abrir todo</button>
      <button class="btn" onclick="expandAll(false)">‚¨ÜÔ∏è Cerrar todo</button>

      <button class="btn danger" onclick="limpiarRepartoHoy()">üßπ Limpiar reparto de hoy</button>

      <button class="btn primary" onclick="finalizarReparto()">‚úÖ Finalizar</button>
      <button class="btn" onclick="imprimirPDF()">üßæ PDF</button>

      <button class="btn" onclick="copiarResumen()">üìã Copiar resumen</button>
      <button class="btn primary" onclick="enviarWhatsAppResumen()">üì≤ WhatsApp +612269440</button>
    </div>
  </div>

  <div class="container">
    <div class="card no-print">
      <div class="hd">
        <strong>C√≥mo usar</strong>
        <span class="pill" id="persistPill">üíæ Guardando‚Ä¶</span>
      </div>
      <div class="bd">
        <div class="muted">
          ‚úÖ Se guarda solo en el m√≥vil (checks + fotos).<br>
          1) Marca ‚úî lo bajado (repartido).<br>
          2) (Opcional) a√±ade fotos por destino.<br>
          3) Pulsa <b>Finalizar</b> para ver el resumen global (bajado + pendiente + fotos).<br>
          4) Pulsa <b>PDF</b> para guardarlo como PDF con fotos incrustadas.<br><br>
          üì≤ WhatsApp abre el chat con el mensaje listo. Para adjuntar el PDF: en WhatsApp ‚Üí clip ‚Üí Documento ‚Üí selecciona el PDF.
        </div>
      </div>
    </div>

    <div class="dest-grid no-print" id="destWrap"></div>

    <!-- RESUMEN GLOBAL -->
    <div class="card summary" id="summaryCard">
      <div class="hd">
        <strong>üìå Resumen final</strong>
        <span class="pill" id="summaryPill">‚Äî</span>
      </div>
      <div class="bd">
        <h2 id="sumTitle">REPARTO</h2>
        <p class="sub" id="sumSub"></p>

        <div class="grid2">
          <div class="card" style="margin:0">
            <div class="hd"><strong>‚úÖ Bajado</strong><span class="pill ok" id="delCount">0</span></div>
            <div class="bd" id="deliveredBox"></div>
          </div>
          <div class="card" style="margin:0">
            <div class="hd"><strong>‚è≥ Pendiente</strong><span class="pill bad" id="pendCount">0</span></div>
            <div class="bd" id="pendingBox"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="hd"><strong>üì∑ Fotos (todas)</strong></div>
          <div class="bd" id="photosAllBox"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ==========================
   Tema
========================== */
function applyTheme(t){
  document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light');
  localStorage.setItem('arslan_reparto_theme', t);
}
function toggleTheme(){
  const cur = localStorage.getItem('arslan_reparto_theme') || 'light';
  applyTheme(cur==='light'?'dark':'light');
}

/* ==========================
   Util
========================== */
const byId = (id)=>document.getElementById(id);
const esc = (s)=>String(s||'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
function todayISO(){ return new Date().toISOString().split('T')[0]; }
function safeJsonParse(s){ try{ return JSON.parse(s); }catch{ return null; } }

/* ==========================
   Estado (repartidor)
========================== */
let payload = null;

// deliveryState[destId][lineId] = true/false
const deliveryState = {};
// photosState[destId] = [{name, dataUrl}]
const photosState = {};

// √öltimo resumen calculado (para WhatsApp/copiar)
let LAST_SUMMARY = null;

/* ==========================
   Persist pill
========================== */
function setPersist(text){
  const p = byId('persistPill');
  if(p) p.textContent = text;
}

/* ==========================
   Persistencia localStorage (por reparto)
========================== */
const LS_PREFIX = 'arslan_reparto_v1';

function computeRepartoKey(){
  const date = payload?.dateISO || todayISO();
  const title = (payload?.title || 'REPARTO').slice(0,60);
  const dcount = (payload?.destinations?.length || 0);
  return `${LS_PREFIX}::${date}::${title}::${dcount}`;
}
function persistNow(){
  if(!payload) return;
  const key = computeRepartoKey();
  const obj = { v:1, savedAt: Date.now(), deliveryState, photosState };
  try{
    localStorage.setItem(key, JSON.stringify(obj));
    setPersist('üíæ Guardado');
  }catch(e){
    setPersist('‚ö†Ô∏è Sin espacio para guardar');
  }
}
let persistTimer = null;
function persistSoon(){
  setPersist('üíæ Guardando‚Ä¶');
  clearTimeout(persistTimer);
  persistTimer = setTimeout(persistNow, 180);
}
function loadPersisted(){
  if(!payload) return false;
  const key = computeRepartoKey();
  const raw = localStorage.getItem(key);
  if(!raw) return false;
  const obj = safeJsonParse(raw);
  if(!obj || !obj.deliveryState || !obj.photosState) return false;

  Object.keys(obj.deliveryState).forEach(destId=>{
    if(!deliveryState[destId]) deliveryState[destId] = {};
    const map = obj.deliveryState[destId] || {};
    Object.keys(map).forEach(lineId=>{
      deliveryState[destId][lineId] = !!map[lineId];
    });
  });

  Object.keys(obj.photosState).forEach(destId=>{
    const arr = Array.isArray(obj.photosState[destId]) ? obj.photosState[destId] : [];
    photosState[destId] = arr
      .filter(x=>x && typeof x.dataUrl==='string' && x.dataUrl.startsWith('data:image/'))
      .map(x=>({ name: String(x.name||'foto'), dataUrl: x.dataUrl }));
  });

  setPersist('üíæ Reparto recuperado');
  return true;
}

function limpiarRepartoHoy(){
  if(!payload){ alert('Sin datos.'); return; }
  if(!confirm('¬øSeguro? Esto borra checks y fotos SOLO de este reparto.')) return;

  payload.destinations.forEach(d=>{
    deliveryState[d.id] = {};
    photosState[d.id] = [];
    d.lines.forEach(ln=> deliveryState[d.id][ln.id] = false);
  });

  const key = computeRepartoKey();
  localStorage.removeItem(key);

  byId('summaryCard').classList.remove('show');
  LAST_SUMMARY = null;

  setPersist('üßπ Reparto limpio');
  render();
}

/* ==========================
   Payload decode (?data=)
========================== */
function getUrlDataParam(){
  const u = new URL(location.href);
  return u.searchParams.get('data');
}
function decodePayload(){
  const packed = getUrlDataParam();
  if(!packed) return null;
  try{
    const json = LZString.decompressFromEncodedURIComponent(packed);
    if(!json) return null;
    const obj = JSON.parse(json);
    if(!obj || !Array.isArray(obj.destinations)) return null;
    return obj;
  }catch(e){
    return null;
  }
}

/* ==========================
   Init base state from payload
========================== */
function initStateFromPayload(){
  payload.destinations.forEach(d=>{
    if(!deliveryState[d.id]) deliveryState[d.id] = {};
    if(!photosState[d.id]) photosState[d.id] = [];
    d.lines.forEach(ln=>{
      if(typeof deliveryState[d.id][ln.id] !== 'boolean') deliveryState[d.id][ln.id] = false;
    });
  });
}

/* ==========================
   Render destinos
========================== */
function render(){
  if(!payload){
    byId('metaLine').textContent = '‚ö†Ô∏è Sin datos. Abre este link desde la app de pedidos.';
    byId('destWrap').innerHTML = '';
    return;
  }

  const meta = `${payload.title || 'REPARTO'} ¬∑ ${payload.dateISO || todayISO()} ¬∑ Destinos: ${payload.destinations.length}`;
  byId('metaLine').textContent = meta;

  const wrap = byId('destWrap');
  wrap.innerHTML = '';

  payload.destinations.forEach(d=>{
    const totalLines = d.lines.length;
    const done = d.lines.filter(ln => deliveryState[d.id]?.[ln.id]).length;

    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.dest = d.id;

    const hd = document.createElement('div');
    hd.className = 'hd';
    hd.innerHTML = `
      <strong>${esc(d.label)}</strong>
      <div class="row-actions">
        <span class="pill ${done===totalLines?'ok':''}">‚úî ${done}/${totalLines}</span>
        <button class="btn" onclick="markAll('${d.id}', true)">Marcar todo</button>
        <button class="btn" onclick="markAll('${d.id}', false)">Desmarcar</button>
        <button class="btn" onclick="toggleDest('${d.id}')">Ver/ocultar</button>
      </div>
    `;

    const bd = document.createElement('div');
    bd.className = 'bd';
    bd.id = `bd_${d.id}`;

    bd.innerHTML = `
      <div class="muted" style="margin-bottom:8px">Marca lo bajado. Lo no marcado quedar√° como pendiente.</div>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th style="width:64px">‚úî</th>
              <th>Producto</th>
              <th style="width:120px">Cantidad</th>
            </tr>
          </thead>
          <tbody id="tb_${d.id}"></tbody>
        </table>
      </div>

      <div class="photo-wrap">
        <div class="row-actions">
          <span class="pill">üì∑ Fotos destino</span>
          <input type="file" accept="image/*" capture="environment" multiple
            id="file_${d.id}" style="display:none" onchange="onAddPhotos('${d.id}', this.files)">
          <button class="btn primary" onclick="byId('file_${d.id}').click()">A√±adir fotos</button>
          <button class="btn" onclick="clearPhotos('${d.id}')">Borrar fotos</button>
        </div>
        <div class="photos" id="ph_${d.id}"></div>
      </div>
    `;

    card.appendChild(hd);
    card.appendChild(bd);
    wrap.appendChild(card);

    // filas
    const tb = byId(`tb_${d.id}`);
    d.lines.forEach(ln=>{
      const tr = document.createElement('tr');
      const checked = !!deliveryState[d.id]?.[ln.id];
      tr.innerHTML = `
        <td><input class="check" type="checkbox" ${checked?'checked':''}
          onchange="setDelivered('${d.id}','${ln.id}', this.checked)"></td>
        <td>${esc(ln.name)}</td>
        <td><b>${esc(ln.qty)}</b></td>
      `;
      tb.appendChild(tr);
    });

    // fotos
    renderPhotos(d.id);
  });

  // ocultar resumen hasta finalizar
  byId('summaryCard').classList.remove('show');
}

/* ==========================
   UI helpers
========================== */
function toggleDest(destId){
  const bd = byId(`bd_${destId}`);
  if(!bd) return;
  bd.style.display = (bd.style.display==='none') ? 'block' : 'none';
}
function expandAll(open){
  payload?.destinations?.forEach(d=>{
    const bd = byId(`bd_${d.id}`);
    if(bd) bd.style.display = open ? 'block' : 'none';
  });
}

/* ==========================
   Checks (persistente)
========================== */
function setDelivered(destId, lineId, val){
  if(!deliveryState[destId]) deliveryState[destId] = {};
  deliveryState[destId][lineId] = !!val;
  persistSoon();
  render();
}
function markAll(destId, val){
  const d = payload.destinations.find(x=>x.id===destId);
  if(!d) return;
  if(!deliveryState[destId]) deliveryState[destId] = {};
  d.lines.forEach(ln=> deliveryState[destId][ln.id] = !!val);
  persistSoon();
  render();
}

/* ==========================
   Fotos (persistente)
========================== */
function onAddPhotos(destId, files){
  if(!files || !files.length) return;
  const arr = Array.from(files);

  let i=0;
  function next(){
    if(i>=arr.length){
      renderPhotos(destId);
      persistSoon();
      return;
    }
    const f = arr[i++];
    const r = new FileReader();
    r.onload = ()=>{
      if(!photosState[destId]) photosState[destId]=[];
      photosState[destId].push({
        name: f.name || ('foto_'+Date.now()+'.jpg'),
        dataUrl: r.result
      });
      next();
    };
    r.readAsDataURL(f);
  }
  next();
}
function renderPhotos(destId){
  const box = byId(`ph_${destId}`);
  if(!box) return;
  const list = photosState[destId] || [];
  if(!list.length){
    box.innerHTML = `<div class="muted">Sin fotos.</div>`;
    return;
  }
  box.innerHTML = '';
  list.forEach((p,idx)=>{
    const d = document.createElement('div');
    d.className = 'ph';
    d.innerHTML = `
      <img src="${p.dataUrl}" alt="${esc(p.name)}">
      <button class="rm" title="Quitar" onclick="removePhoto('${destId}', ${idx})">‚úï</button>
    `;
    box.appendChild(d);
  });
}
function removePhoto(destId, idx){
  const list = photosState[destId] || [];
  list.splice(idx,1);
  photosState[destId] = list;
  renderPhotos(destId);
  persistSoon();
}
function clearPhotos(destId){
  if(!confirm('¬øBorrar todas las fotos de este destino?')) return;
  photosState[destId] = [];
  renderPhotos(destId);
  persistSoon();
}

/* ==========================
   Construir resumen (para UI + WhatsApp + copiar)
========================== */
function buildSummary(){
  if(!payload) return null;

  const delivered = []; // {destLabel,name,qty}
  const pending = [];
  const photosAll = []; // {destLabel,dataUrl,name}

  payload.destinations.forEach(d=>{
    d.lines.forEach(ln=>{
      const ok = !!deliveryState[d.id]?.[ln.id];
      const row = { destLabel:d.label, name:ln.name, qty:ln.qty };
      if(ok) delivered.push(row);
      else pending.push(row);
    });

    (photosState[d.id] || []).forEach(ph=>{
      photosAll.push({ destLabel:d.label, dataUrl:ph.dataUrl, name:ph.name });
    });
  });

  return {
    title: payload.title || 'REPARTO',
    dateISO: payload.dateISO || todayISO(),
    destinationsCount: payload.destinations.length,
    delivered,
    pending,
    photosAll
  };
}

function renderSummaryUI(sum){
  byId('summaryPill').textContent = `‚úÖ Bajado ${sum.delivered.length} ¬∑ ‚è≥ Pendiente ${sum.pending.length} ¬∑ üì∑ Fotos ${sum.photosAll.length}`;
  byId('sumTitle').textContent = sum.title;
  byId('sumSub').textContent = `${sum.dateISO} ¬∑ Destinos ${sum.destinationsCount}`;

  byId('delCount').textContent = sum.delivered.length;
  byId('pendCount').textContent = sum.pending.length;

  byId('deliveredBox').innerHTML = renderSummaryTable(sum.delivered, true);
  byId('pendingBox').innerHTML = renderSummaryTable(sum.pending, false);
  byId('photosAllBox').innerHTML = renderPhotosAll(sum.photosAll);

  byId('summaryCard').classList.add('show');
}

function renderSummaryTable(rows, isOk){
  if(!rows.length) return `<div class="muted">${isOk?'Nada bajado.':'Nada pendiente.'}</div>`;

  const map = new Map();
  rows.forEach(r=>{
    if(!map.has(r.destLabel)) map.set(r.destLabel, []);
    map.get(r.destLabel).push(r);
  });

  let out = '';
  for(const [label, items] of map.entries()){
    out += `<div class="card" style="margin:0 0 10px; box-shadow:none">
      <div class="hd" style="border:1px solid var(--border); border-radius:14px; margin-bottom:6px">
        <strong>${esc(label)}</strong>
        <span class="pill ${isOk?'ok':'bad'}">${items.length}</span>
      </div>
      <div class="bd" style="padding:0 10px 10px">
        <div style="overflow-x:auto">
          <table>
            <thead><tr><th>Producto</th><th style="width:120px">Cantidad</th></tr></thead>
            <tbody>
              ${items.map(x=>`<tr><td>${esc(x.name)}</td><td><b>${esc(x.qty)}</b></td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>`;
  }
  return out;
}
function renderPhotosAll(list){
  if(!list.length) return `<div class="muted">Sin fotos.</div>`;

  const map = new Map();
  list.forEach(p=>{
    if(!map.has(p.destLabel)) map.set(p.destLabel, []);
    map.get(p.destLabel).push(p);
  });

  let out = '';
  for(const [label, items] of map.entries()){
    out += `<div class="card" style="margin:0 0 12px; box-shadow:none">
      <div class="hd" style="border:1px solid var(--border); border-radius:14px; margin-bottom:6px">
        <strong>${esc(label)}</strong>
        <span class="pill">${items.length}</span>
      </div>
      <div class="bd">
        <div class="photos">
          ${items.map(p=>`<div class="ph"><img src="${p.dataUrl}" alt="${esc(p.name)}"></div>`).join('')}
        </div>
      </div>
    </div>`;
  }
  return out;
}

/* ==========================
   Finalizar / PDF
========================== */
function finalizarReparto(){
  if(!payload){ alert('Sin datos.'); return; }
  const sum = buildSummary();
  LAST_SUMMARY = sum;
  renderSummaryUI(sum);
  byId('summaryCard').scrollIntoView({behavior:'smooth', block:'start'});
}
function imprimirPDF(){
  if(payload && !byId('summaryCard').classList.contains('show')){
    finalizarReparto();
  }
  window.print();
}

/* ==========================
   WhatsApp + Copiar resumen
========================== */
function buildWhatsAppText(sum){
  // Mensajes largos se pueden cortar en WhatsApp. Aqu√≠ usamos un l√≠mite seguro aproximado.
  const MAX = 3200;

  function groupLines(rows){
    const map = new Map();
    rows.forEach(r=>{
      if(!map.has(r.destLabel)) map.set(r.destLabel, []);
      map.get(r.destLabel).push(r);
    });
    return map;
  }

  let text = '';
  text += `üöö *${sum.title}*\n`;
  text += `üìÖ ${sum.dateISO}\n`;
  text += `üìç Destinos: ${sum.destinationsCount}\n`;
  text += `‚úÖ Bajado: ${sum.delivered.length}\n`;
  text += `‚è≥ Pendiente: ${sum.pending.length}\n`;
  text += `üì∑ Fotos: ${sum.photosAll.length}\n\n`;

  text += `‚úÖ *BAJADO*\n`;
  const g1 = groupLines(sum.delivered);
  for(const [label, items] of g1.entries()){
    text += `\n*${label}*\n`;
    items.forEach(it=>{ text += `- ${it.qty} ${it.name}\n`; });
    if(text.length > MAX) break;
  }

  if(text.length <= MAX){
    text += `\n‚è≥ *PENDIENTE*\n`;
    const g2 = groupLines(sum.pending);
    for(const [label, items] of g2.entries()){
      text += `\n*${label}*\n`;
      items.forEach(it=>{ text += `- ${it.qty} ${it.name}\n`; });
      if(text.length > MAX) break;
    }
  }

  if(text.length > MAX){
    text = text.slice(0, MAX);
    text += `\n\n‚ö†Ô∏è Mensaje recortado por longitud. El PDF contiene el informe completo con fotos.`;
  }else{
    text += `\nüßæ PDF: adjunto informe completo con fotos (generado desde la app).`;
  }
  return text;
}

function enviarWhatsAppResumen(){
  if(!payload){ alert('Sin datos.'); return; }
  if(!byId('summaryCard').classList.contains('show')){
    finalizarReparto();
  }
  const sum = LAST_SUMMARY || buildSummary();
  LAST_SUMMARY = sum;

  const phone = '612269440'; // sin +
  const msg = encodeURIComponent(buildWhatsAppText(sum));
  // abre chat con n√∫mero
  window.open(`https://wa.me/${phone}?text=${msg}`, '_blank');
}

function copiarResumen(){
  if(!payload){ alert('Sin datos.'); return; }
  if(!byId('summaryCard').classList.contains('show')){
    finalizarReparto();
  }
  const sum = LAST_SUMMARY || buildSummary();
  LAST_SUMMARY = sum;

  const txt = buildWhatsAppText(sum);
  navigator.clipboard.writeText(txt);
  alert('Resumen copiado. P√©galo en WhatsApp si quieres.');
}

/* ==========================
   INIT
========================== */
(function init(){
  const savedTheme = localStorage.getItem('arslan_reparto_theme') || (matchMedia && matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  applyTheme(savedTheme);

  payload = decodePayload();
  if(!payload){
    byId('metaLine').textContent = '‚ö†Ô∏è Sin datos. Abre este link desde la app de pedidos.';
    setPersist('‚ö†Ô∏è Sin datos');
    return;
  }
  if(!payload.dateISO) payload.dateISO = todayISO();
  if(!payload.title) payload.title = 'REPARTO';

  initStateFromPayload();
  loadPersisted();

  render();
  persistSoon();

  window.addEventListener('beforeunload', ()=>{ try{ persistNow(); }catch{} });
  document.addEventListener('visibilitychange', ()=>{
    if(document.visibilityState==='hidden'){ try{ persistNow(); }catch{} }
  });
})();
</script>
</body>
</html>
